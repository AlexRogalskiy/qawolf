import Link from "next/link";

import Header from "../../components/Docs/Header";
import Image from "../../components/Docs/Image";
import Layout from "../../components/Docs/Layout";
import SubHeader from "../../components/Docs/SubHeader";

<Layout>

<Header>Run on Netlify Deployment</Header>

In this tutorial, we'll set up our tests to run on <a href="https://www.netlify.com/" target="_blank">Netlify</a> deployments. This helps ensure our critical workflows don't break when we make changes.

Specifically, we'll run our tests whenever a <a href="https://www.netlify.com/blog/2016/07/20/introducing-deploy-previews-in-netlify/" target="_blank">Netlify Deploy Preview</a> succeeds in a <a href="https://github.com/" target="_blank">GitHub</a> pull request. If you have a different workflow, please <Link href="community">reach out for help</Link>.

<SubHeader>Create Deployment Trigger</SubHeader>

First, we'll create a trigger that runs our tests on Netlify deployments. QA Wolf uses triggers to know how and when to run your tests.

Open a test you want to run on Netlify deployments. Click the "Add trigger" button in the top right corner to open the triggers menu.

<Image
  alt="Add trigger"
  height={221}
  src="/docs/run-on-schedule/add-trigger.png"
  width={1600}
/>

A popup will open with options to create a trigger. Click on the "Deployment" tab in the middle.

Make sure that Netlify is selected as your deploy service. You can also optionally rename your trigger.

Now we'll connect our GitHub repository (repo) to QA Wolf. Click the "Connect GitHub repository" button to get started.

<Image
  alt="Connect GitHub repository"
  height={489}
  src="/docs/run-on-netlify-deployment/github-repo.png"
  width={600}
/>

A new tab will open and visit GitHub. You will be asked to choose the repo(s) you want QA Wolf to access.

<Image
  alt="Install GitHub App"
  height={528}
  src="/docs/run-on-netlify-deployment/install-github-app.png"
  width={400}
/>

Choose the repo(s) you want to test and click the green "Install" button. After the installation succeeds, the new tab will close.

Confirm the repo you want to test is now selected in the dropdown.

<Image
  alt="Choose GitHub repo"
  height={340}
  src="/docs/run-on-netlify-deployment/choose-repo.png"
  width={974}
/>

### Choose Environment

Finally, specify which <Link href="use-environment-variables">environment</Link> you want to use when your tests run.

<Image
  alt="Choose environment"
  height={322}
  src="/docs/run-on-vercel-deployment/choose-environment.png"
  width={978}
/>

Press the "Create trigger" button to save your new trigger. ðŸŽ‰

After your trigger is created, the popup will show a list of triggers and whether they are assigned to your test.

Clicking on the trigger will toggle whether it is assigned to your test. You can also edit or delete a trigger from this popup.

<Image
  alt="Edit triggers for test"
  height={496}
  src="/docs/run-on-netlify-deployment/edit-triggers.png"
  width={972}
/>

<SubHeader>Update Tests to Use Deploy Preview URL</SubHeader>

Because our Netlify Deploy Preview URL isn't known in advance, QA Wolf passes it as an <Link href="use-environment-variables">environment variable</Link> (`process.env.URL`) when a Deploy Preview succeeds.

We need to update our tests to use this environment variable when specified.

Replace the URL in your tests with `process.env.URL`. For example, let's say our test currently starts with:

```js
const { context } = await launch();
const page = await context.newPage();
await page.goto("https://default.netlify.app/", {
  waitUntil: "domcontentloaded",
});
```

Let's update the `page.goto` call to go to `process.env.URL` if it exists, and our default URL otherwise:

```js
const { context } = await launch();
const page = await context.newPage();
// go to process.env.URL if specified, and the default URL otherwise
await page.goto(process.env.URL || "https://default.netlify.app/", {
  waitUntil: "domcontentloaded",
});
```

<SubHeader>See QA Wolf Results in GitHub</SubHeader>

Now when you make a pull request on GitHub, your tests will run after your Netlify Preview Deploy succeeds.

<Image
  alt="See QA Wolf results in GitHub"
  height={598}
  src="/docs/run-on-netlify-deployment/github-checks.png"
  width={1200}
/>

<SubHeader>Conclusion</SubHeader>

Now that our tests run on Netlify deployments, let's <Link href="send-slack-alerts">alert our team</Link> when they fail.

</Layout>
