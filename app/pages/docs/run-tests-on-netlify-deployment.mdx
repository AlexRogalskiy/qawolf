import Link from "next/link";

import AssignTrigger from "../../components/Docs/AssignTrigger";
import ChooseEnvironment from "../../components/Docs/ChooseEnvironment";
import CreateTrigger from "../../components/Docs/CreateTrigger";
import ExternalLink from "../../components/Docs/ExternalLink";
import Header from "../../components/Docs/Header";
import Image from "../../components/Docs/Image";
import InstallGitHubApp from "../../components/Docs/InstallGitHubApp";
import Layout from "../../components/Docs/Layout";
import SubHeader from "../../components/Docs/SubHeader";
import ViewRunHistory from "../../components/Docs/ViewRunHistory";

<Layout>

<Header>Run Tests on Netlify Deployment</Header>

In this tutorial, we'll set up our tests to run on <a href="https://www.netlify.com/" target="_blank">Netlify</a> deployments. This helps ensure our critical workflows don't break when we make changes.

Specifically, we'll run our tests whenever a <a href="https://www.netlify.com/blog/2016/07/20/introducing-deploy-previews-in-netlify/" target="_blank">Netlify Deploy Preview</a> succeeds in a <a href="https://github.com/" target="_blank">GitHub</a> pull request. If you have a different workflow, please <ExternalLink href="https://slack.qawolf.com">reach out for help</ExternalLink>.

<SubHeader>Create Deployment Trigger</SubHeader>

<CreateTrigger description="on Netlify Deploy Previews" />

<InstallGitHubApp service="netlify" />

<ChooseEnvironment />

<SubHeader>Assign Deployment Trigger to Test</SubHeader>

<AssignTrigger doc="run-tests-on-netlify-deployment" />

<SubHeader>Update Tests to Use Deploy Preview URL</SubHeader>

Because our Netlify Deploy Preview URL isn't known in advance, QA Wolf passes it as an <Link href="use-environment-variables">environment variable</Link> (`process.env.URL`) when a Deploy Preview succeeds.

We need to update our tests to use this environment variable when specified.

Replace the URL in your tests with `process.env.URL`. For example, let's say our test currently starts with:

```js
const { context } = await launch();
const page = await context.newPage();
await page.goto("https://default.netlify.app/", {
  waitUntil: "domcontentloaded",
});
```

Let's update the `page.goto` call to go to `process.env.URL` if it exists, and our default URL otherwise:

```js
const { context } = await launch();
const page = await context.newPage();
// go to process.env.URL if specified, and the default URL otherwise
await page.goto(process.env.URL || "https://default.netlify.app/", {
  waitUntil: "domcontentloaded",
});
```

<SubHeader>See QA Wolf Results in GitHub</SubHeader>

Now when you make a pull request on GitHub, your tests will run after your Netlify Preview Deploy succeeds.

<Image
  alt="See QA Wolf results in GitHub"
  height={299}
  src="/docs/run-tests-on-netlify-deployment/github-checks.png"
  width={600}
/>

<ViewRunHistory description="on Netlify Deploy Previews" />

</Layout>
