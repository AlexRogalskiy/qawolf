import Header from "../../components/Docs/Header";
import Layout from "../../components/Docs/Layout";
import SubHeader from "../../components/Docs/SubHeader";

<Layout>

<Header>Test Receiving Email</Header>

QA Wolf supports testing email out of the box. This is helpful for scenarios like:

- Sign in with a login code
- Email notifications after an event happens
- Password reset

<SubHeader>Create Test Email Address</SubHeader>

QA Wolf provides a helper method called `getInbox`. This method returns an object with the following keys:

- `email`: test email address
- `waitForMessage`: function that waits for an email message to the test address

You can optionally pass `{ new: true }` to `getInbox` to get a fresh inbox.

```js
const { email, waitForMessage } = getInbox(); // default inbox for your team
const { email, waitForMessage } = getInbox({ new: true }); // fresh inbox
```

<SubHeader>Use Test Email Address</SubHeader>

You can now use the test email address in your test. For example, at QA Wolf we use `getInbox` in our sign in test, since our sign in requires a login code.

In the example below, we 1) create a test email address, 2) fill out the sign in form, and 3) get the login code from the email subject line.

```js
// create test email address
const { email, waitForMessage } = getInbox();

// fill out sign in form
await page.fill('[name="email"]', email);
await page.click('[aria-label="Sign up with email"]');

// get login code from email subject
const { subject } = await waitForMessage();
const code = subject.split(": ")[1].split("-").join("");
```

The message returned by `waitForMessage` has the following fields:

- `from`: sender of the email
- `html`: HTML body of the email if it exists
- `subject`: subject line of the email
- `text`: email body in plain text formatting
- `to`: recipient of the email

<SubHeader>Configure waitForMessage</SubHeader>

You can optionally specify `timeout` and `after` when calling `waitForMessage`.

Use the `timeout` option to specify how long in milliseconds QA Wolf should wait to receive an email before throwing an error. The default value is `60000` (1 minute). This means that QA Wolf waits up to 1 minute to receive an email message. If none is received by then, the test fails.

```js
const { subject } = await waitForMessage({ timeout: 2 * 60 * 1000 }); // 2 minutes
```

Use the `after` option to wait for an email that is received after a specified `Date`.

For example, at QA Wolf we use the same test to test sign up and log in. When we log in the second time, we need to make sure to get the latest login code. Otherwise, `waitForMessage` would return the email with the first login code immediately.

```js
// keep track of when we log in the second time
const after = new Date();

// log in
await page.fill('[name="email"]', email);
await page.click('[aria-label="Log in with email"]');

// get login code from email sent after specified date
const { subject } = await waitForMessage({ after });
```

</Layout>
